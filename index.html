<script>
(function () {
  const defaultState = {
    "Downstairs": "NOT OK",
    "Upstairs": "NOT OK",
    "Across the Road": "OK"
  };

  // общий ключ для кеша в браузере (опционально, просто чтобы не дёргать API лишний раз)
  const PLACES_KEY = 'toilet_status_places_v2';

  // URL твоего бекенда. Если HTML и API на одном домене — можно просто '/status'
  const API_URL = '/status';

  let state = {};
  const placesEl = document.getElementById('places');

  async function loadState() {
    // 1. сначала пробуем сходить на сервер — это и даёт шаринг между людьми/браузерами
    try {
      const resp = await fetch(API_URL, { cache: 'no-store' });
      if (resp.ok) {
        const data = await resp.json();
        if (data && typeof data === 'object') {
          console.log('Loaded state from API:', data);
          // сохраним в localStorage как кеш
          localStorage.setItem(PLACES_KEY, JSON.stringify(data));
          // подстраховка: если в defaultState появятся новые ключи — они появятся и тут
          return { ...defaultState, ...data };
        }
      } else {
        console.warn('API returned non-OK status:', resp.status);
      }
    } catch (e) {
      console.error('Error loading state from API, fallback to local:', e);
    }

    // 2. если API не ответил — берём кеш из localStorage
    try {
      const raw = localStorage.getItem(PLACES_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        console.log('Loaded state from localStorage:', parsed);
        return { ...defaultState, ...parsed };
      }
    } catch (e) {
      console.error('Error loading state from localStorage:', e);
    }

    // 3. если совсем ничего нет — дефолт
    console.log('Using default state');
    return { ...defaultState };
  }

  async function saveStateRemote(s) {
    try {
      const resp = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(s)
      });

      if (!resp.ok) {
        console.warn('Failed to save state to API, status:', resp.status);
        return false;
      }

      console.log('State saved to API successfully');
      return true;
    } catch (e) {
      console.error('Error saving state to API:', e);
      return false;
    }
  }

  async function saveState(s) {
    // всегда сохраняем локально как кеш
    try {
      localStorage.setItem(PLACES_KEY, JSON.stringify(s));
    } catch (e) {
      console.error('Error saving state to localStorage:', e);
    }

    // и пробуем сохранить на сервер (если не получится — UI всё равно обновится локально)
    await saveStateRemote(s);
  }

  function renderPlaces() {
    placesEl.innerHTML = '';

    Object.keys(state).forEach((place) => {
      const isOk = state[place] === 'OK';

      const card = document.createElement('div');
      card.className = 'card';

      const placeName = document.createElement('div');
      placeName.className = 'place';
      placeName.textContent = place;

      const status = document.createElement('div');
      status.className = 'status ' + (isOk ? 'ok' : 'bad');
      status.textContent = isOk ? 'WORKING OK' : 'OUT OF ORDER';

      const controls = document.createElement('div');
      controls.className = 'controls';

      const btnToggle = document.createElement('button');
      btnToggle.className = 'btn btn-toggle';
      btnToggle.textContent = isOk ? 'Mark as Out of Order' : 'Mark as Working';

      btnToggle.onclick = async function () {
        const current = state[place] === 'OK';
        state[place] = current ? 'NOT OK' : 'OK';
        await saveState(state);
        renderPlaces();
      };

      controls.appendChild(btnToggle);

      card.appendChild(placeName);
      card.appendChild(status);
      card.appendChild(controls);

      placesEl.appendChild(card);
    });
  }

  // init
  (async function init() {
    state = await loadState();
    renderPlaces();
  })();

  // reset для отладки / админа
  window.__toilet_reset = async function () {
    state = { ...defaultState };
    await saveState(state);
    renderPlaces();
    alert('Status reset to default');
  };
})();
</script>
